# 虚拟机热点缓存与迭代器快速路径优化报告（中文版）

## 执行摘要

本次优化聚焦于 VM 热路径缓存与迭代器快速路径，通过 f-string/表达式解析缓存与 range/array 迭代优化降低解释器开销。当前代码在基准测试中获得 **9.54% 的平均 VM 性能提升**。

## 环境信息

- **Node.js 版本**: v20.19.6
- **Python 版本**: 3.12.3
- **CPU**: AMD EPYC 7763 64核处理器
- **操作系统**: Linux
- **日期**: 2026年1月18日（基准测试运行时间）

## 第一步：建立基线（Baseline）

### 方法论
- 5 次基准测试运行，参数保持一致
- 7 种工作负载：斐波那契(30)、列表操作(100万)、质数查找(25000-30000)、字典操作(25万)、嵌套循环(1118x1118)、字符串操作(10万)、列表推导(25万)
- VM 与 CPython 同时执行用于正确性验证

### 基线结果

| 运行 | VM时间(ms) | Python时间(ms) | 比率 |
|------|-----------|---------------|------|
| 1    | 9112.60   | 656.74        | 13.88x |
| 2    | 9146.06   | 641.62        | 14.25x |
| 3    | 9020.18   | 630.30        | 14.31x |
| 4    | 9200.40   | 656.57        | 14.01x |
| 5    | 9184.93   | 647.04        | 14.20x |

**统计数据：**
- **平均值**: 9132.83ms
- **标准差**: 64.12ms (0.70%)
- **最小/最大**: 9020.18ms / 9200.40ms

## 第二步：优化后性能

### 优化结果

| 运行 | VM时间(ms) | Python时间(ms) | 比率 |
|------|-----------|---------------|------|
| 1    | 8344.71   | 666.60        | 12.52x |
| 2    | 8244.18   | 668.02        | 12.34x |
| 3    | 8259.38   | 641.93        | 12.87x |
| 4    | 8220.82   | 648.36        | 12.68x |
| 5    | 8237.98   | 649.92        | 12.68x |

**统计数据：**
- **平均值**: 8261.41ms
- **标准差**: 43.44ms (0.53%)
- **最小/最大**: 8220.82ms / 8344.71ms

### 提升幅度

- **绝对提升**: 871.42ms
- **相对提升**: 9.54%

## 关键优化点

1. **Range 对象与快速迭代路径**
   - 引入轻量 range 类并在执行循环中增加 array/range 的快速迭代分支。

2. **F-string 模板缓存**
   - 缓存模板解析结果，避免重复正则解析与格式化拆分。

3. **表达式解析缓存**
   - 缓存 f-string 插值表达式的 AST，减少词法与语法解析成本。

4. **locals 同步优化**
   - 通过维护未同步列表，降低频繁的 scope/locals 同步开销。

5. **函数参数绑定优化**
   - 精简参数绑定过程，避免热点调用中的多余数组操作。

## 优化尝试与贡献拆解

| 尝试 | 变更 | 平均 VM 时间 (ms) | 相对基线 | 相对上一步 |
|------|------|------------------|----------|------------|
| 基线 | 无 | 9132.83 | - | - |
| A | Range 对象（未引入迭代快速路径） | 9105.50 | **+0.30%** | +0.30% |
| B | array/range 迭代快速路径 | 9294.26 | **-1.77%** | -2.07% |
| C | f-string 表达式解析缓存 | 8086.37 | **+11.46%** | +13.00% |
| D（最终） | 模板缓存 + 有界缓存清理 + locals 同步 + 参数绑定 | 8261.41 | **+9.54%** | -2.16% |

**说明：**
- 最大收益来自 f-string 表达式解析缓存（相对基线约 +11.46%）。
- 迭代快速路径单独测量时出现回退，但与其他优化组合后仍保留在最终方案中。
- 缓存裁剪与 locals 同步优化牺牲少量峰值收益，换取有界内存和稳定正确性。

## 正确性验证

- 7 个基准工作负载与 CPython 输出一致（7/7）。
- 开发过程中维持 vitest 通过。

## 结论

本轮优化通过缓存与迭代器快速路径降低了解释器热路径开销，基准测试平均提升 **9.54%**，并保持稳定的波动与正确性，为后续进一步优化（如更细粒度的迭代器专用路径与缓存策略）奠定基础。
